pipeline {
    agent any

    environment {
        DOCKER_HUB_USER = 'brianchoi506'
        APP_NAME = 'ticket-api-server'
        DOCKER_HUB_PASS = credentials('docker-hub')

        // Credentials ID (Github 토큰 설정이 완료되었다고 가정)
        // EC2 접속 정보
        EC2_HOST = 'ubuntu@3.26.171.218'
    }

    stages {

        stage('Build Jar') {
            steps {
                echo '=== Gradle Build ==='
                   sh 'chmod +x ./gradlew || true'
                   sh './gradlew clean build -x test'
                }
            }


        stage('Build & Push Docker Image') {
            steps {
                echo '=== Docker Build & Push ==='
                script {
                    // 도커 로그인
                    sh "echo $DOCKER_HUB_PASS | docker login -u $DOCKER_HUB_USER --password-stdin"
                    sh "docker build --platform linux/amd64 -t $DOCKER_HUB_USER/$APP_NAME:latest ./ticket-api-server"
                    // 푸시
                    sh "docker push $DOCKER_HUB_USER/$APP_NAME:latest"
                }
            }
        }

        stage('Deploy to EC2') {
                    steps {
                        echo '=== Deploy on EC2 ==='

                        withCredentials([
                            file(credentialsId: 'env', variable: 'ENV_FILE'),
                            file(credentialsId: 'debezium-config', variable: 'DEBEZIUM_JSON'),
                            sshUserPrivateKey(credentialsId: 'ssh-key', keyFileVariable: 'SSH_KEY', usernameVariable: 'SSH_USER')
                        ]) {
                            sh '''#!/bin/bash
                            set -euo pipefail
                            HOST=$(echo "$EC2_HOST" | cut -d'@' -f2)
                            USER=$SSH_USER
                            REMOTE_DIR="/home/ubuntu/ticket-app"

                            echo "[1/4] EC2 환경 선제 조치 (원격 sudo)"
                            ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no "$USER@$HOST" \
                                "sudo mkdir -p $REMOTE_DIR && sudo chown -R $USER:$USER $REMOTE_DIR && sudo rm -f $REMOTE_DIR/register-debezium.json"

                            echo "[2/4] 파일 전송"
                            scp -i "$SSH_KEY" -o StrictHostKeyChecking=no "$ENV_FILE" "$USER@$HOST:$REMOTE_DIR/.env"
                            scp -i "$SSH_KEY" -o StrictHostKeyChecking=no docker-compose.yml "$USER@$HOST:$REMOTE_DIR/"
                            scp -r -i "$SSH_KEY" -o StrictHostKeyChecking=no ./monitoring "$USER@$HOST:$REMOTE_DIR/"
                            scp -i "$SSH_KEY" -o StrictHostKeyChecking=no "$DEBEZIUM_JSON" "$USER@$HOST:$REMOTE_DIR/register-debezium.json"

                            echo "[3/4] 원격 서버 작업 (Heredoc 방식)"
                            ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no "$USER@$HOST" << 'EOF'
                                set -e
                                REMOTE_DIR="/home/ubuntu/ticket-app"
                                cd "$REMOTE_DIR"
                                export PATH=$PATH:/usr/local/bin:/usr/libexec/docker/cli-plugins

                                echo "API 서버 갱신 중..."
                                docker compose pull api-server-1
                                docker compose up -d --remove-orphans

                                echo "Kafka Connect 대기 중..."
                                for i in {1..20}; do
                                    if curl -s http://localhost:8083/connectors > /dev/null; then
                                        echo "Connect API Ready!"
                                        break
                                    fi
                                    sleep 5
                                done

                                echo "Debezium 커넥터 등록/업데이트..."
                                HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8083/connectors/ticket-mysql-connector)

                                if [ "$HTTP_CODE" -eq 200 ]; then
                                    echo "기존 커넥터 업데이트 (PUT)"
                                    curl -i -X PUT -H 'Content-Type: application/json' \
                                         -d @register-debezium.json \
                                         http://localhost:8083/connectors/ticket-mysql-connector/config
                                else
                                    echo "신규 커넥터 등록 (POST)"
                                    curl -i -X POST -H 'Content-Type: application/json' \
                                         -d @register-debezium.json \
                                         http://localhost:8083/connectors
                                fi

                                docker image prune -af || true
        EOF
                            '''
                        }
                    }
                }
    }

    post {
            always {
                echo '=== Pipeline Finished ==='
                cleanWs()
            }

            success {
                echo '✅ 배포 성공!'
            }

            failure {
                echo '❌ 배포 실패!'
            }
        }
}